name: Build and Deploy

on:
  push:
    branches:
      - develop

jobs:
  build:
    name: Build backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create archive
        run: |
          set -euxo pipefail
          rm -rf dist
          mkdir -p dist
          # Copie les fichiers n√©cessaires dans 'dist' en excluant les √©l√©ments inutiles
          rsync -a --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='.DS_Store' \
            --exclude='dist' \
            ./ dist/
          # Cr√©e l'archive √† partir du dossier temporaire 'dist'
          tar -czf snoroc_back.tar.gz -C dist .
          ls -lh snoroc_back.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: snoroc_back
          path: snoroc_back.tar.gz
          if-no-files-found: error

---
deploy:
  name: Deploy backend to VPS
  runs-on: ubuntu-latest
  needs: build
  steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: snoroc_back
        path: .

    - name: Copy archive to VPS using rsync üîÑ
      # On utilise rsync-action pour contourner le probl√®me du .bashrc
      uses: gregoryg/rsync-action@v1.0.1
      with:
        # Utilise la cl√© SSH pour l'authentification
        ssh_private_key: ${{ secrets.SSH_KEY }}
        # Source locale (l'archive t√©l√©charg√©e)
        source: ./snoroc_back.tar.gz
        # Destination : le dossier /tmp/ sur le serveur
        target: ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
        # Force la suppression des arguments rsync non compatibles
        args: '--delete-excluded'

    - name: Deploy and restart backend
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -euxo pipefail
          echo "üöÄ Starting deployment on VPS..."

          # **ATTENTION** : Le bon chemin o√π est clon√© ton projet sur le VPS
          PROJECT_DIR="/home/ubuntu/snoroc-dev/snoroc_back"

          mkdir -p "$PROJECT_DIR"

          # 1. Sauvegarde du fichier .env existant
          tmp_env=""
          if [ -f "$PROJECT_DIR/.env" ]; then
            tmp_env=$(mktemp)
            cp "$PROJECT_DIR/.env" "$tmp_env"
            echo "File .env backed up."
          fi

          # 2. Nettoyage du dossier (sauf le .env)
          echo "Cleaning old application files (except .env)..."
          find "$PROJECT_DIR" -mindepth 1 -maxdepth 1 ! -name '.env' -exec rm -rf {} +

          # 3. Extraction de la nouvelle archive
          echo "Extracting new application files..."
          tar -xzf /tmp/snoroc_back.tar.gz -C "$PROJECT_DIR"

          # 4. Restauration du fichier .env
          if [ -n "${tmp_env:-}" ] && [ -f "$tmp_env" ]; then
            mv "$tmp_env" "$PROJECT_DIR/.env"
            echo "File .env restored."
          fi

          # 5. Nettoyage de l'archive temporaire
          rm -f /tmp/snoroc_back.tar.gz

          # 6. D√©marrage de Docker Compose (depuis le bon dossier)
          cd "$PROJECT_DIR"
          echo "Building and restarting Docker containers..."
          # On utilise --build pour s'assurer que l'image est bien reconstruite avec le nouveau code
          sudo docker compose -f docker-compose.yaml up -d --build api

          echo "‚úÖ Backend deployed and restarted successfully"

    - name: Verify API response
      run: |
        echo "üåê Checking API response..."
        sleep 5
        # Le sleep est l√† pour laisser le temps au container de d√©marrer
        curl -s http://${{ secrets.SSH_HOST }}:3030 || echo "‚ö†Ô∏è API check failed"
